<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>キャラアニメーションエディター</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f8f8f8;
      padding: 1em;
      text-align: center;
    }
    canvas {
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
    }
    .controls {
      margin-top: 10px;
    }
    .controls input, .controls button {
      margin: 0.3em;
    }
  </style>
</head>
<body>
  <h2>キャラアニメーションエディター</h2>
  <canvas id="canvas" width="600" height="400"></canvas>
  <div class="controls">
    <label>画像アップロード：
      <input type="file" id="imageInput" multiple />
    </label><br>
    <label>パーツ名：
      <select id="partSelect">
        <option value="head">頭</option>
        <option value="body">体</option>
        <option value="tail">しっぽ</option>
        <option value="wing1">羽1</option>
        <option value="wing2">羽2</option>
        <option value="arm1">手1</option>
        <option value="arm2">手2</option>
        <option value="leg1">足1</option>
        <option value="leg2">足2</option>
      </select>
    </label>
    <button id="saveBtn">保存</button>
    <input type="file" id="loadInput" accept=".json" />
    <button id="animateBtn">アニメーション</button>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const parts = {};
    let currentDrag = null, offsetX = 0, offsetY = 0;

    function drawAll() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const key in parts) {
        const part = parts[key];
        const { img, x, y, angle = 0 } = part;
        ctx.save();
        ctx.translate(x + img.width / 2, y + img.height / 2);
        ctx.rotate(angle * Math.PI / 180);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        ctx.restore();
      }
    }

    canvas.addEventListener('mousedown', e => {
      const mx = e.offsetX, my = e.offsetY;
      for (const key in parts) {
        const part = parts[key];
        const { img, x, y } = part;
        if (mx >= x && mx <= x + img.width && my >= y && my <= y + img.height) {
          currentDrag = key;
          offsetX = mx - x;
          offsetY = my - y;
          break;
        }
      }
    });

    canvas.addEventListener('mousemove', e => {
      if (currentDrag) {
        const mx = e.offsetX, my = e.offsetY;
        parts[currentDrag].x = mx - offsetX;
        parts[currentDrag].y = my - offsetY;
        drawAll();
      }
    });

    canvas.addEventListener('mouseup', () => currentDrag = null);

    document.getElementById('imageInput').addEventListener('change', e => {
      const files = e.target.files;
      const partName = document.getElementById('partSelect').value;
      if (!files.length) return;
      const file = files[0];
      const img = new Image();
      img.onload = () => {
        parts[partName] = {
          img,
          x: 100,
          y: 100,
          angle: 0
        };
        drawAll();
      };
      img.src = URL.createObjectURL(file);
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      const data = {};
      for (const key in parts) {
        data[key] = {
          src: parts[key].img.src,
          x: parts[key].x,
          y: parts[key].y,
          angle: parts[key].angle || 0
        };
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'character_parts.json';
      link.click();
    });

    document.getElementById('loadInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const data = JSON.parse(reader.result);
        const promises = [];
        for (const key in data) {
          const { src, x, y, angle } = data[key];
          const img = new Image();
          const p = new Promise(resolve => {
            img.onload = () => {
              parts[key] = { img, x, y, angle };
              resolve();
            };
            img.src = src;
          });
          promises.push(p);
        }
        Promise.all(promises).then(drawAll);
      };
      reader.readAsText(file);
    });

    document.getElementById('animateBtn').addEventListener('click', () => {
      if (!parts.body || !parts.head) return;
      const timeline = anime.timeline({
        easing: 'easeInOutSine',
        duration: 400,
        autoplay: false,
        update: drawAll
      });

      timeline.add({
        targets: [parts.body, parts.head],
        angle: 35,
        x: el => el.x - 10,
        y: el => el.y + 2
      }).add({
        targets: [parts.arm1, parts.arm2, parts.leg1, parts.leg2],
        angle: 20,
        x: el => el.x - 5,
        y: el => el.y + 5,
        offset: 0
      });

      timeline.add({
        targets: [parts.body, parts.head],
        angle: 0,
        x: el => el.x + 20,
        y: el => el.y - 2,
        duration: 400
      }).add({
        targets: [parts.arm1, parts.arm2, parts.leg1, parts.leg2],
        angle: 0,
        x: el => el.x + 5,
        y: el => el.y - 5,
        offset: 400
      });

      timeline.play();
    });
  </script>
</body>
</html>
